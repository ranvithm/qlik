"use strict";function __awaiter(e,n,o,h){return new(o=o||Promise)(function(i,t){function s(e){try{a(h.next(e))}catch(e){t(e)}}function r(e){try{a(h.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?i(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(s,r)}a((h=h.apply(e,n||[])).next())})}const saasLinks={isLoggedIn:"/api/v1/audits",user:"/api/v1/users/me",users:"/api/v1/users?limit=100",tenant:"/api/v1/tenants/me",apps:"/api/v1/items?limit=100&resourceType=app",themes:"/api/v1/themes",space:"/api/v1/spaces?limit=100&type=managed,shared"};class Qlik{constructor(e){this.currApps=[],this.getMeasure=e=>new Promise(t=>{this.getList(e,"MeasureList").then(e=>{t(e.qMeasureList.qItems)})}),this.getVariable=e=>new Promise(t=>{this.getList(e,"VariableList").then(e=>{t(e.qVariableList.qItems)})}),this.getFields=e=>new Promise(t=>{this.getList(e,"FieldList").then(e=>{t(e.qFieldList.qItems)})}),this.getBookmark=e=>new Promise(t=>{this.getList(e,"BookmarkList").then(e=>{t(e.qBookmarkList.qItems)})}),this.evaluateExpression=(i,s)=>new Promise(t=>{var e;s&&" "!==s&&"object"==typeof s?i&&i.createGenericObject({value:{qStringExpression:null==(e=null==s?void 0:s.qStringExpression)?void 0:e.qExpr}},function(e){t(e.value),i.destroySessionObject(e.qInfo.qId)}):t(s)}),this.objectProper=(n,o)=>new Promise(t=>{const e=o.properties,i=e.title,s=e.subtitle,r=e.footnote,a={title:null,subtitle:null,footnote:null};this.evaluateExpression(n,i).then(e=>(a.title=e,this.evaluateExpression(n,s))).then(e=>(a.subtitle=e,this.evaluateExpression(n,r))).then(e=>{a.footnote=e,t(a)})}),this.getQlikObjectTitles=(s,e)=>new Promise(i=>{s.getObjectProperties(e).then(e=>{var t=e.properties;t.qExtendsId?s.getObjectProperties(t.qExtendsId).then(e=>{this.objectProper(s,e).then(e=>{i(e)})}):this.objectProper(s,e).then(e=>{i(e)})})}),this.getSheet=n=>new Promise(a=>{this.getList(n,"sheet").then(e=>{var t=[];for(const i of e.qAppObjectList.qItems){const s=[];for(const r of i.qData.cells)this.getQlikObjectTitles(n,r.name).then(e=>{var t=e.title||e.subtitle||e.footnote||r.name;s.push(Object.assign(Object.assign({},r),{options:e,obj_id:r.name,id:r.name,title:t}))}),i.obj=s;t.push(Object.assign(Object.assign({},i),{name:i.qMeta.title,id:i.qInfo.qId}))}a(t)})}),this.callObject=(i,s)=>new Promise(t=>{var e;null!=(e=i.visualization)&&e.get&&i.visualization.get(s).then(e=>{t(e)}).catch(e=>{console.log(e)})}),this.checkAppOpen=i=>new Promise((e,t)=>{i.model.waitForOpen.promise.then(()=>{e(i)}).catch(e=>{t(e)})}),this.isAppOpen=t=>__awaiter(this,void 0,void 0,function*(){var e=this.qlik.openApp(t,this.config);return yield this.checkAppOpen(e),e});var{host:t,port:i,prefix:s,isSecure:r,ticket:a,webIntegrationId:n=""}=e,s="/"!==s?s:"/",r=r?"https://":"http://",i=i?":"+i:"";this.config=e,this.ticket=a,this.isSaaS=!!n,this.webIntegrationId=n,this.baseUrl=r+t+i+s+"resources",this.saasURL=r+t+i}callRequire(){return new Promise((t,i)=>{try{if(!document.getElementById("qlik-require-file")){const r=document.createElement("script");r.src=this.ticket?this.baseUrl+"/assets/external/requirejs/require.js?"+this.ticket:this.baseUrl+"/assets/external/requirejs/require.js",r.id="qlik-require-file",document.head.appendChild(r);var e=new Promise((e,t)=>{r.onload=()=>e("loaded"),r.onerror=e=>t(e)});const a=document.createElement("link");a.href=this.baseUrl+"/autogenerated/qlik-styles.css",a.type="text/css",a.rel="stylesheet",document.head.insertBefore(a,document.head.firstChild);var s=new Promise((e,t)=>{a.onload=()=>e("loaded"),a.onerror=e=>t(e)});Promise.all([e,s]).then(e=>{t(e)}).catch(e=>{i(e)})}}catch(e){console.log(e),i(e)}})}setQlik(){return new Promise((t,i)=>{window.require.config({baseUrl:this.baseUrl,paths:{qlik:this.baseUrl+"/js/qlik"},config:{text:{useXhr(){return!0}}},webIntegrationId:this.isSaaS?this.webIntegrationId:""}),window.require(["js/qlik"],e=>{e&&(e.setOnError(e=>{i(e)}),this.qlik=e,t(e))})})}fetchAPI(e,t="GET",i=null){return fetch(""+this.saasURL+e,{method:t,mode:"cors",credentials:"include",headers:{"Content-Type":"application/json","qlik-web-integration-id":this.webIntegrationId},body:i}).then(e=>200===e.status&&e.json())}authenticateToQlik(){return __awaiter(this,void 0,void 0,function*(){const i=window.location.origin;return yield fetch(this.saasURL+"/"+saasLinks.isLoggedIn,{credentials:"include",headers:{"Qlik-Web-Integration-ID":this.webIntegrationId}}).then(t=>__awaiter(this,void 0,void 0,function*(){var e;401===t.status&&((e=new URL(this.saasURL+"/login")).searchParams.append("qlik-web-integration-id",this.webIntegrationId),e.searchParams.append("returnto",i),window.location.href=i)})).catch(function(e){console.error(e)})})}setAuthUser(){return new Promise(s=>__awaiter(this,void 0,void 0,function*(){if(this.isSaaS)try{var e=yield this.fetchAPI(saasLinks.user),t=yield this.fetchAPI(saasLinks.tenant);this.user=Object.assign(Object.assign({directory:t.name,userId:e.name},e),{tenant:t}),s(!0)}catch(e){console.log(e),this.authenticateToQlik()}else this.qlik.callRepository("/api/hub/v1/user/info").then(e=>{var e=e.data.data[0],{userDirectory:t,userId:i}=e.attributes;this.user={directory:t,userId:i,authUser:e},s(!0)}).catch(e=>{console.log(e)})}))}getMoreData(i,s){return __awaiter(this,void 0,void 0,function*(){var e,t=i;return t.links&&t.links.next?(e=yield this.fetchAPI(t.links.next.href),s=[...s,...e.data],yield this.getMoreData(e,s)):(t.data=s,t)})}getSpace(e){return this.fetchAPI("api/v1/spaces/"+e)}getSpaceList(){return __awaiter(this,void 0,void 0,function*(){var e=yield this.fetchAPI(saasLinks.space),t=[...e.data];return(yield this.getMoreData(e,t)).data})}getUserList(){return __awaiter(this,void 0,void 0,function*(){var e=yield this.fetchAPI(saasLinks.users),t=[...e.data];return yield this.getMoreData(e,t)})}getAppList(){return __awaiter(this,void 0,void 0,function*(){var e=yield this.fetchAPI(saasLinks.apps),t=[...e.data];return(yield this.getMoreData(e,t)).data})}getThemeList(){return __awaiter(this,void 0,void 0,function*(){var e=yield this.fetchAPI(saasLinks.themes),t=[...e.data];return(yield this.getMoreData(e,t)).data})}getDocs(){return new Promise(t=>{this.qlik.getAppList(e=>{this.docList=e,t(e)},this.config)})}getList(i,e){return new Promise(t=>{i.getList(e,e=>{t(e),i.destroySessionObject(e.qInfo.qId)})})}getApp(n){return __awaiter(this,void 0,void 0,function*(){var e,t,i,s,r,a;if(!this.currApps.find(e=>e.app.id===n))return e=yield this.isAppOpen(n),t=yield this.getSheet(e),i=yield this.getMeasure(e),s=yield this.getFields(e),r=yield this.getVariable(e),a=yield this.getBookmark(e),this.currApps=[{id:n,app:e,sheet:t,measure:i,fields:s,variable:r,bookmark:a},...this.currApps],this.currApps})}}module.exports=Qlik;
