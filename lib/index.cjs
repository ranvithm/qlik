"use strict";function e(e,t,i,s){return new(i||(i=Promise))((function(o,n){function r(e){try{l(s.next(e))}catch(e){n(e)}}function a(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}l((s=s.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const t="/api/v1/audits",i="/api/v1/users/me",s="/api/v1/users?limit=100",o="/api/v1/tenants/me",n="/api/v1/items?limit=100&resourceType=app",r="/api/v1/themes",a="/api/v1/spaces?limit=100&type=managed,shared";module.exports=class{constructor(e){var t;this.currApps=[];const{host:i,port:s,prefix:o="/",isSecure:n,ticket:r,webIntegrationId:a=""}=e;this.isCssRequired=null===(t=e.isCssRequired)||void 0===t||t;const l=n?"https://":"http://",c=s?`:${s}`:"";this.config=e,this.ticket=r,this.isSaaS=!!a,this.webIntegrationId=a,this.baseUrl=`${l}${i}${c}${o}resources`,this.saasURL=`${l}${i}${c}`}appendScript(e,t){return new Promise(((i,s)=>{const o=document.createElement("script");o.src=e,o.id=t,o.onload=()=>i(),o.onerror=()=>s(new Error(`Failed to load script: ${e}`)),document.head.appendChild(o)}))}appendStylesheet(e){return new Promise(((t,i)=>{const s=document.querySelector('link[href*="qlik-styles.css"]');s&&s.remove();const o=document.createElement("link");o.href=e,o.type="text/css",o.rel="stylesheet",o.onload=()=>{const e=document.createElement("div");e.id="qlik-style-container",document.body.appendChild(e),t()},o.onerror=()=>i(new Error(`Failed to load stylesheet: ${e}`)),document.head.prepend(o)}))}callRequire(){return e(this,void 0,void 0,(function*(){if(!document.getElementById("qlik-require-file")){const e=this.ticket?`${this.baseUrl}/assets/external/requirejs/require.js?${this.ticket}`:`${this.baseUrl}/assets/external/requirejs/require.js`;if(yield this.appendScript(e,"qlik-require-file"),this.isCssRequired){const e=this.ticket?`${this.baseUrl}/autogenerated/qlik-styles.css?${this.ticket}`:`${this.baseUrl}/autogenerated/qlik-styles.css`;yield this.appendStylesheet(e)}window.Promise||(yield this.appendScript(`${this.baseUrl}/assets/external/es6-promise/es6-promise.auto.js`,"es6-promise"))}}))}setQlik(){return e(this,void 0,void 0,(function*(){return yield this.callRequire(),new Promise(((e,t)=>{window.require.config({baseUrl:this.baseUrl,paths:{qlik:`${this.baseUrl}/js/qlik`},config:{text:{useXhr:()=>!0}},webIntegrationId:this.isSaaS?this.webIntegrationId:"",waitSeconds:20,onError:e=>{console.error("Failed to load Qlik module:",e),t(e)}}),window.require(["js/qlik"],(i=>{i?(i.setOnError((e=>{console.error("Qlik engine error:",e),t(e)})),this.qlik=i,e(i)):t(new Error("Failed to initialize Qlik"))}))}))}))}fetchAPI(e,t="GET",i=null){return fetch(e,{method:t,mode:"cors",credentials:"include",headers:{"Content-Type":"application/json","qlik-web-integration-id":this.webIntegrationId},body:i?JSON.stringify(i):null}).then((e=>200!==e.status?Promise.reject(new Error(`Failed with status ${e.status}`)):e.json()))}openAuthPopup(t){return e(this,arguments,void 0,(function*(e,t=600,i=600){return new Promise(((s,o)=>{const n=window.screenX+(window.outerWidth-t)/2,r=window.screenY+(window.outerHeight-i)/2,a=window.open(e,"QlikLogin",`width=${t},height=${i},left=${n},top=${r}`);if(!a)return void o(new Error("Failed to open authentication popup. Please allow popups for this site."));const l=setInterval((()=>{a.closed&&(clearInterval(l),this.checkAuthStatus().then(s).catch(o))}),500);window.addEventListener("message",(e=>{var t;e.origin===this.saasURL&&"qlik-auth-success"===(null===(t=e.data)||void 0===t?void 0:t.type)&&(clearInterval(l),a.close(),s(e.data.user))}),{once:!0})}))}))}checkAuthStatus(){return e(this,void 0,void 0,(function*(){try{if(200===(yield fetch(`${this.saasURL}${t}`,{credentials:"include",headers:{"Qlik-Web-Integration-ID":this.webIntegrationId}})).status)return this.setAuthUser();throw new Error("Authentication failed")}catch(e){throw console.error("Authentication status check failed:",e),e}}))}authenticateToQlik(){return e(this,void 0,void 0,(function*(){var e;if(this.isSaaS)try{if(401===(yield fetch(`${this.saasURL}${t}`,{credentials:"include",headers:{"Qlik-Web-Integration-ID":this.webIntegrationId}})).status){const t=new URL(`${this.saasURL}/login`);if(t.searchParams.append("qlik-web-integration-id",this.webIntegrationId),"popup"===(null===(e=this.config.auth)||void 0===e?void 0:e.method)){const{popupWidth:e=600,popupHeight:i=600}=this.config.auth;yield this.openAuthPopup(t.toString(),e,i),this.config.auth.loginCallback&&this.config.auth.loginCallback(this.user)}else t.searchParams.append("returnto",window.location.origin),window.location.href=t.toString()}}catch(e){throw console.error("Authentication failed:",e),e}else if(this.ticket)try{yield this.qlik.callRepository("/api/hub/v1/user/info","GET",JSON.stringify({"X-Qlik-Session":this.ticket}))}catch(e){throw console.error("Enterprise ticket authentication failed:",e),this.config.loginUri&&(window.location.href=this.config.loginUri),e}else try{yield this.qlik.callRepository("/api/hub/v1/user/info")}catch(e){throw console.error("Enterprise authentication failed:",e),e}}))}setAuthUser(){return e(this,void 0,void 0,(function*(){if(this.isSaaS)try{const e=yield this.fetchAPI(`${this.saasURL}${i}`),t=yield this.fetchAPI(`${this.saasURL}${o}`);this.user=Object.assign(Object.assign({directory:t.name,userId:e.name},e),{tenant:t})}catch(e){console.error(e),yield this.authenticateToQlik()}else try{const e=(yield this.qlik.callRepository("/api/hub/v1/user/info")).data.data[0],{userDirectory:t,userId:i}=e.attributes;this.user={directory:t,userId:i,authUser:e}}catch(e){console.error(e)}}))}getMoreData(t){return e(this,void 0,void 0,(function*(){var e,i;let s=Object.assign({},t),o=t.data;for(;null===(i=null===(e=null==s?void 0:s.links)||void 0===e?void 0:e.next)||void 0===i?void 0:i.href;){const e=yield this.fetchAPI(s.links.next.href);o=o.concat(e.data),s=e}return Object.assign(Object.assign({},s),{data:o})}))}getSpace(t){return e(this,void 0,void 0,(function*(){if(!this.isSaaS)throw new Error("Spaces are only available in Qlik Sense SaaS");return this.fetchAPI(`${this.saasURL}/api/v1/spaces/${t}`)}))}getSpaceList(){return e(this,void 0,void 0,(function*(){if(!this.isSaaS)throw new Error("Spaces are only available in Qlik Sense SaaS");const e=yield this.fetchAPI(`${this.saasURL}${a}`);return(yield this.getMoreData(e)).data}))}getUserList(){return e(this,void 0,void 0,(function*(){if(!this.isSaaS){return(yield this.qlik.callRepository("/api/hub/v1/users")).data}const e=yield this.fetchAPI(`${this.saasURL}${s}`);return(yield this.getMoreData(e)).data}))}getAppList(){return e(this,void 0,void 0,(function*(){if(!this.isSaaS)return new Promise((e=>{this.qlik.getAppList((t=>{e(t)}))}));const e=yield this.fetchAPI(`${this.saasURL}${n}`);return(yield this.getMoreData(e)).data}))}getThemeList(){return e(this,void 0,void 0,(function*(){if(!this.isSaaS){return(yield this.qlik.callRepository("/api/hub/v1/themes")).data}const e=yield this.fetchAPI(`${this.saasURL}${r}`);return(yield this.getMoreData(e)).data}))}getDocs(){return e(this,void 0,void 0,(function*(){return new Promise((e=>{this.qlik.getAppList((t=>{this.docList=t,e(t)}),this.config)}))}))}getList(t,i){return e(this,void 0,void 0,(function*(){return new Promise((e=>{t.getList(i,(i=>{e(i),t.destroySessionObject(i.qInfo.qId)}))}))}))}getMeasure(t){return e(this,void 0,void 0,(function*(){return(yield this.getList(t,"MeasureList")).qMeasureList.qItems}))}getVariable(t){return e(this,void 0,void 0,(function*(){return(yield this.getList(t,"VariableList")).qVariableList.qItems}))}getFields(t){return e(this,void 0,void 0,(function*(){return(yield this.getList(t,"FieldList")).qFieldList.qItems}))}getBookmark(t){return e(this,void 0,void 0,(function*(){return(yield this.getList(t,"BookmarkList")).qBookmarkList.qItems}))}evaluateExpression(t,i){return e(this,void 0,void 0,(function*(){return new Promise((e=>{var s;i&&" "!==i&&"object"==typeof i?t.createGenericObject({value:{qStringExpression:null===(s=null==i?void 0:i.qStringExpression)||void 0===s?void 0:s.qExpr}},(i=>{e(i.value),t.destroySessionObject(i.qInfo.qId)})):e(i)}))}))}objectProper(t,i){return e(this,void 0,void 0,(function*(){const e=i.properties,s={title:null,subtitle:null,footnote:null};return s.title=yield this.evaluateExpression(t,e.title),s.subtitle=yield this.evaluateExpression(t,e.subtitle),s.footnote=yield this.evaluateExpression(t,e.footnote),s}))}getQlikObjectTitles(t,i){return e(this,void 0,void 0,(function*(){const e=yield t.getObjectProperties(i);if(e.properties.qExtendsId){const i=yield t.getObjectProperties(e.properties.qExtendsId);return this.objectProper(t,i)}return this.objectProper(t,e)}))}getSheet(t){return e(this,void 0,void 0,(function*(){const i=yield this.getList(t,"sheet");return yield Promise.all(i.qAppObjectList.qItems.map((i=>e(this,void 0,void 0,(function*(){const s=yield Promise.all(i.qData.cells.map((i=>e(this,void 0,void 0,(function*(){const e=yield this.getQlikObjectTitles(t,i.name);return Object.assign(Object.assign({},i),{options:e,obj_id:i.name,id:i.name,title:e.title||e.subtitle||e.footnote||i.name})})))));return Object.assign(Object.assign({},i),{name:i.qMeta.title,id:i.qInfo.qId,obj:s})})))))}))}callObject(t,i){return e(this,void 0,void 0,(function*(){var e;if(null===(e=t.visualization)||void 0===e?void 0:e.get)return t.visualization.get(i).catch(console.error)}))}checkAppOpen(t){return e(this,void 0,void 0,(function*(){return yield t.model.waitForOpen.promise,t}))}setupEngineConnectionMonitoring(e){e.model.engineVersion().then((e=>{console.log("Connected to Qlik Engine version:",e)})),e.model.on("changed",(()=>{console.debug("Engine connection: Model changed")})),e.model.on("closed",(()=>{console.warn("Engine connection: Model closed"),this.currApps.find((t=>t.app===e))&&this.isAppOpen(e.id).catch(console.error)})),e.model.on("suspended",(()=>{console.warn("Engine connection: Model suspended")})),e.model.on("restored",(()=>{console.log("Engine connection: Model restored")}))}getSessionKey(e){return`qlik_session_${this.config.host}_${e}`}saveSessionState(e){var t,i,s;if(!e||!e.id)return;const o=this.getSessionKey(e.id),n={timestamp:Date.now(),selections:(null===(t=e.selectionState)||void 0===t?void 0:t.qSelections)||[],variables:{}};(null===(i=this.currApps.find((t=>t.app===e)))||void 0===i?void 0:i.variable)&&(null===(s=this.currApps.find((t=>t.app===e)))||void 0===s||s.variable.forEach((t=>{t.qName&&e.variable.getContent(t.qName,(e=>{n.variables[t.qName]=e.qContent.qString}))})));try{sessionStorage.setItem(o,JSON.stringify(n))}catch(e){console.warn("Failed to save session state:",e)}}restoreSessionState(t){return e(this,void 0,void 0,(function*(){var e,i;if(!t||!t.id)return;const s=this.getSessionKey(t.id);try{const o=sessionStorage.getItem(s);if(!o)return;const n=JSON.parse(o);if(Date.now()-n.timestamp>864e5)return void sessionStorage.removeItem(s);if(null===(e=n.selections)||void 0===e?void 0:e.length)for(const e of n.selections)if(e.field&&(null===(i=e.values)||void 0===i?void 0:i.length)){const i=t.field(e.field);yield i.selectValues(e.values,!1)}for(const[e,i]of Object.entries(n.variables))t.variable.setContent(e,String(i))}catch(e){console.warn("Failed to restore session state:",e)}}))}isAppOpen(t){return e(this,void 0,void 0,(function*(){const e=Object.assign(Object.assign({},this.config),{openWithoutData:!0,noData:!1,secure:this.config.isSecure}),i=this.qlik.openApp(t,e);this.setupEngineConnectionMonitoring(i),i.model.on("changed",(()=>{this.saveSessionState(i)}));const s=yield this.checkAppOpen(i);return yield this.restoreSessionState(s),s}))}getApp(t){return e(this,void 0,void 0,(function*(){if(!this.currApps.find((e=>e.app.id===t)))try{const e=yield this.isAppOpen(t),[i,s,o,n,r]=yield Promise.all([this.getSheet(e),this.getMeasure(e),this.getFields(e),this.getVariable(e),this.getBookmark(e)]);this.currApps=[{id:t,app:e,sheet:i,measure:s,fields:o,variable:n,bookmark:r},...this.currApps],e.model.on("error",(e=>{console.error("App model error:",e)}))}catch(e){throw console.error("Failed to open app:",e),e}return this.currApps}))}};
//# sourceMappingURL=index.cjs.map
