!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).index=t()}(this,function(){"use strict";function a(e,o,a,h){return new(a=a||Promise)(function(i,t){function s(e){try{r(h.next(e))}catch(e){t(e)}}function n(e){try{r(h.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?i(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(s,n)}r((h=h.apply(e,o||[])).next())})}const n={isLoggedIn:"/api/v1/audits",user:"/api/v1/users/me",users:"/api/v1/users?limit=100",tenant:"/api/v1/tenants/me",apps:"/api/v1/items?limit=100&resourceType=app",themes:"/api/v1/themes",space:"/api/v1/spaces?limit=100&type=managed,shared"};return class{constructor(e){this.currApps=[],this.getMeasure=e=>new Promise(t=>{this.getList(e,"MeasureList").then(e=>{t(e.qMeasureList.qItems)})}),this.getVariable=e=>new Promise(t=>{this.getList(e,"VariableList").then(e=>{t(e.qVariableList.qItems)})}),this.getFields=e=>new Promise(t=>{this.getList(e,"FieldList").then(e=>{t(e.qFieldList.qItems)})}),this.getBookmark=e=>new Promise(t=>{this.getList(e,"BookmarkList").then(e=>{t(e.qBookmarkList.qItems)})}),this.evaluateExpression=(i,s)=>new Promise(t=>{var e;s&&" "!==s&&"object"==typeof s?i&&i.createGenericObject({value:{qStringExpression:null==(e=null==s?void 0:s.qStringExpression)?void 0:e.qExpr}},function(e){t(e.value),i.destroySessionObject(e.qInfo.qId)}):t(s)}),this.objectProper=(o,a)=>new Promise(t=>{const e=a.properties,i=e.title,s=e.subtitle,n=e.footnote,r={title:null,subtitle:null,footnote:null};this.evaluateExpression(o,i).then(e=>(r.title=e,this.evaluateExpression(o,s))).then(e=>(r.subtitle=e,this.evaluateExpression(o,n))).then(e=>{r.footnote=e,t(r)})}),this.getQlikObjectTitles=(s,e)=>new Promise(i=>{s.getObjectProperties(e).then(e=>{var t=e.properties;t.qExtendsId?s.getObjectProperties(t.qExtendsId).then(e=>{this.objectProper(s,e).then(e=>{i(e)})}):this.objectProper(s,e).then(e=>{i(e)})})}),this.getSheet=o=>new Promise(r=>{this.getList(o,"sheet").then(e=>{var t=[];for(const i of e.qAppObjectList.qItems){const s=[];for(const n of i.qData.cells)this.getQlikObjectTitles(o,n.name).then(e=>{var t=e.title||e.subtitle||e.footnote||n.name;s.push(Object.assign(Object.assign({},n),{options:e,obj_id:n.name,id:n.name,title:t}))}),i.obj=s;t.push(Object.assign(Object.assign({},i),{name:i.qMeta.title,id:i.qInfo.qId}))}r(t)})}),this.callObject=(i,s)=>new Promise(t=>{var e;null!=(e=i.visualization)&&e.get&&i.visualization.get(s).then(e=>{t(e)}).catch(e=>{console.log(e)})}),this.checkAppOpen=i=>new Promise((e,t)=>{i.model.waitForOpen.promise.then(()=>{e(i)}).catch(e=>{t(e)})}),this.isAppOpen=t=>a(this,void 0,void 0,function*(){var e=this.qlik.openApp(t,this.config);return yield this.checkAppOpen(e),e});var{host:t,port:i,prefix:s,isSecure:n,ticket:r,webIntegrationId:o=""}=e,s="/"!==s?s:"/",n=n?"https://":"http://",i=i?":"+i:"";this.config=e,this.ticket=r,this.isSaaS=!!o,this.webIntegrationId=o,this.baseUrl=n+t+i+s+"resources",this.saasURL=n+t+i}callRequire(){return new Promise((t,i)=>{try{if(!document.getElementById("qlik-require-file")){const n=document.createElement("script");n.src=this.ticket?this.baseUrl+"/assets/external/requirejs/require.js?"+this.ticket:this.baseUrl+"/assets/external/requirejs/require.js",n.id="qlik-require-file",document.head.appendChild(n);var e=new Promise((e,t)=>{n.onload=()=>e("loaded"),n.onerror=e=>t(e)});const r=document.createElement("link");r.href=this.baseUrl+"/autogenerated/qlik-styles.css",r.type="text/css",r.rel="stylesheet",document.head.insertBefore(r,document.head.firstChild);var s=new Promise((e,t)=>{r.onload=()=>e("loaded"),r.onerror=e=>t(e)});Promise.all([e,s]).then(e=>{t(e)}).catch(e=>{i(e)})}}catch(e){console.log(e),i(e)}})}setQlik(){return new Promise((t,i)=>{window.require.config({baseUrl:this.baseUrl,paths:{qlik:this.baseUrl+"/js/qlik"},config:{text:{useXhr(){return!0}}},webIntegrationId:this.isSaaS?this.webIntegrationId:""}),window.require(["js/qlik"],e=>{e&&(e.setOnError(e=>{i(e)}),this.qlik=e,t(e))})})}fetchAPI(e,t="GET",i=null){return fetch(""+this.saasURL+e,{method:t,mode:"cors",credentials:"include",headers:{"Content-Type":"application/json","qlik-web-integration-id":this.webIntegrationId},body:i}).then(e=>200===e.status&&e.json())}authenticateToQlik(){return a(this,void 0,void 0,function*(){const i=window.location.origin;return yield fetch(this.saasURL+"/"+n.isLoggedIn,{credentials:"include",headers:{"Qlik-Web-Integration-ID":this.webIntegrationId}}).then(t=>a(this,void 0,void 0,function*(){var e;401===t.status&&((e=new URL(this.saasURL+"/login")).searchParams.append("qlik-web-integration-id",this.webIntegrationId),e.searchParams.append("returnto",i),window.location.href=i)})).catch(function(e){console.error(e)})})}setAuthUser(){return new Promise(s=>a(this,void 0,void 0,function*(){if(this.isSaaS)try{var e=yield this.fetchAPI(n.user),t=yield this.fetchAPI(n.tenant);this.user=Object.assign(Object.assign({directory:t.name,userId:e.name},e),{tenant:t}),s(!0)}catch(e){console.log(e),this.authenticateToQlik()}else this.qlik.callRepository("/api/hub/v1/user/info").then(e=>{var e=e.data.data[0],{userDirectory:t,userId:i}=e.attributes;this.user={directory:t,userId:i,authUser:e},s(!0)}).catch(e=>{console.log(e)})}))}getMoreData(i,s){return a(this,void 0,void 0,function*(){var e,t=i;return t.links&&t.links.next?(e=yield this.fetchAPI(t.links.next.href),s=[...s,...e.data],yield this.getMoreData(e,s)):(t.data=s,t)})}getSpace(e){return this.fetchAPI("api/v1/spaces/"+e)}getSpaceList(){return a(this,void 0,void 0,function*(){var e=yield this.fetchAPI(n.space),t=[...e.data];return(yield this.getMoreData(e,t)).data})}getUserList(){return a(this,void 0,void 0,function*(){var e=yield this.fetchAPI(n.users),t=[...e.data];return yield this.getMoreData(e,t)})}getAppList(){return a(this,void 0,void 0,function*(){var e=yield this.fetchAPI(n.apps),t=[...e.data];return(yield this.getMoreData(e,t)).data})}getThemeList(){return a(this,void 0,void 0,function*(){var e=yield this.fetchAPI(n.themes),t=[...e.data];return(yield this.getMoreData(e,t)).data})}getDocs(){return new Promise(t=>{this.qlik.getAppList(e=>{this.docList=e,t(e)},this.config)})}getList(i,e){return new Promise(t=>{i.getList(e,e=>{t(e),i.destroySessionObject(e.qInfo.qId)})})}getApp(o){return a(this,void 0,void 0,function*(){var e,t,i,s,n,r;if(!this.currApps.find(e=>e.app.id===o))return e=yield this.isAppOpen(o),t=yield this.getSheet(e),i=yield this.getMeasure(e),s=yield this.getFields(e),n=yield this.getVariable(e),r=yield this.getBookmark(e),this.currApps=[{id:o,app:e,sheet:t,measure:i,fields:s,variable:n,bookmark:r},...this.currApps],this.currApps})}}});
